# 작업 일지 - 2026-01-22 11:14

## 1. 작업 개요

MG(Molecular Grading) 추론 결과가 모든 환자에서 동일하게 나오는 버그 발견 및 수정

---

## 2. 문제 발견

### 2.1 증상
- MG 추론 시 모든 환자(OCS)에서 동일한 결과 출력
- WinMerge로 확인 시 실제 RNA 발현량(Expression)은 환자별로 다름

### 2.2 원인 분석
FastAPI 서버의 `/api/v1/mg/test` API를 직접 호출하여 테스트 수행

**CSV 파일 구조:**
```csv
Hugo_Symbol,Entrez_Gene_Id,Expression
LOC100130426,100130426,0.0
UBE2Q2P3,100133144,8.2018
...
```

**버그 원인:** `mg_service.py`의 `load_csv()` 메서드가 두 번째 열(`Entrez_Gene_Id`)을 expression으로 사용
- `Entrez_Gene_Id`는 유전자 ID로 모든 환자에서 동일
- 실제 발현량은 세 번째 열(`Expression`)

---

## 3. 수정 내용

### 3.1 수정 파일
`modAI/services/mg_service.py`

### 3.2 수정된 메서드
- `load_csv()` (Line 50-89)
- `load_csv_content()` (Line 91-130)

### 3.3 수정 코드
```python
# 변경 전
if df.shape[1] >= 2:
    gene_names = df.iloc[:, 0].astype(str).tolist()
    gene_expression = df.iloc[:, 1].astype(float).tolist()  # 버그!

# 변경 후
if 'Expression' in df.columns:
    gene_names = df['Hugo_Symbol'].astype(str).tolist() if 'Hugo_Symbol' in df.columns else df.iloc[:, 0].astype(str).tolist()
    gene_expression = df['Expression'].astype(float).tolist()  # 수정!
elif df.shape[1] >= 3:
    gene_names = df.iloc[:, 0].astype(str).tolist()
    gene_expression = df.iloc[:, -1].astype(float).tolist()
elif df.shape[1] >= 2:
    gene_names = df.iloc[:, 0].astype(str).tolist()
    gene_expression = df.iloc[:, 1].astype(float).tolist()
```

---

## 4. 로컬 검증

### 4.1 Docker 컨테이너 재시작
```bash
docker restart nn-fastapi nn-fastapi-celery
```

### 4.2 테스트 결과 (15개 짝수 OCS)

| OCS_ID | Risk Score | Grade | Surv(일) | TMZ Response |
|--------|------------|-------|----------|--------------|
| ocs_0016 | -2.6592 | Grade IV | 1479 | Uncertain |
| ocs_0018 | -2.6791 | Grade IV | 1482 | Uncertain |
| ocs_0020 | -2.6964 | Grade IV | 1484 | Uncertain |
| ocs_0022 | -2.5161 | Grade IV | 1461 | Likely Responsive |
| ocs_0024 | -2.6804 | Grade IV | 1482 | Uncertain |
| ocs_0026 | -2.5868 | Grade IV | 1470 | Uncertain |
| ocs_0028 | -2.5534 | Grade IV | 1466 | Likely Responsive |
| ocs_0030 | -2.6329 | Grade IV | 1476 | Uncertain |
| ocs_0032 | -2.5871 | Grade IV | 1471 | Uncertain |
| ocs_0034 | -2.6101 | Grade IV | 1473 | Uncertain |
| ocs_0036 | -2.6487 | Grade IV | 1478 | Uncertain |
| ocs_0038 | -2.6659 | Grade IV | 1480 | Uncertain |
| ocs_0040 | -2.7075 | Grade IV | 1485 | Likely Resistant |
| ocs_0042 | -2.5983 | Grade IV | 1472 | Uncertain |
| ocs_0044 | -2.6009 | Grade IV | 1472 | Uncertain |

### 4.3 수정 전후 비교

| 지표 | 수정 전 | 수정 후 |
|------|---------|---------|
| Risk Score 범위 | -3.0560 (모두 동일) | -2.7075 ~ -2.5161 |
| Risk Score 차이 | 0.0000 | 0.1915 |
| Survival Days | 1525 (모두 동일) | 1461 ~ 1485 |

---

## 5. 원격 서버 배포

### 5.1 서버 정보
- IP: 34.46.109.203
- 사용자: acorn
- 경로: ~/brain_tumor_dev/

### 5.2 배포 과정

#### Step 1: Docker 컨테이너 중지
```bash
docker stop nn-django nn-fastapi nn-fastapi-celery
```

#### Step 2: AI 결과 폴더 삭제 (권한 문제로 sudo 필요)
```bash
sudo rm -rf ~/brain_tumor_dev/CDSS_STORAGE/AI/*
```

#### Step 3: mg_service.py 수정
```bash
nano ~/brain_tumor_dev/modAI/services/mg_service.py
```
로컬에서 수정한 내용과 동일하게 수정

#### Step 4: Docker 컨테이너 재시작
```bash
docker start nn-django nn-fastapi nn-fastapi-celery
```

#### Step 5: Nginx 재시작 (502 Bad Gateway 해결)
```bash
docker restart nn-nginx
```

### 5.3 최종 컨테이너 상태
```
nn-nginx          healthy
nn-django         healthy
nn-fastapi        healthy
nn-fastapi-celery unhealthy (정상 작동 중)
nn-orthanc        unhealthy
nn-django-db      healthy
nn-redis          healthy
```

---

## 6. 생성된 문서

- `mg_0122_문제.md` - MG 버그 상세 분석 보고서
- `0122_1114.md` - 작업 일지 (본 문서)

---

## 7. 결론

- MG 추론 버그 원인: CSV 파싱 시 잘못된 열(Entrez_Gene_Id) 사용
- 해결: Expression 열을 올바르게 읽도록 수정
- 로컬 및 원격 서버 모두 배포 완료
- 서비스 정상 작동 확인
