# MG 추론 동일 결과 버그 분석 보고서

**작성일**: 2026-01-22
**상태**: 수정 완료

---

## 1. 문제 현상

- 모든 환자(OCS)에 대해 MG 추론 결과가 **동일하게 출력**됨
- WinMerge로 확인 시 실제 RNA 발현량(Expression)은 환자별로 **다름**

---

## 2. 원인 분석

### 2.1 문제 위치

| 파일 | 메서드 | 라인 |
|------|--------|------|
| `modAI/services/mg_service.py` | `load_csv()` | 64-66 |
| `modAI/services/mg_service.py` | `load_csv_content()` | 93-95 |

### 2.2 CSV 파일 구조

```csv
Hugo_Symbol,Entrez_Gene_Id,Expression
LOC100130426,100130426,0.0
UBE2Q2P3,100133144,8.2018
HMGB1P1,10357,195.9425
...
```

| 열 번호 | 열 이름 | 내용 | 특성 |
|--------|---------|------|------|
| 0 | `Hugo_Symbol` | 유전자 심볼 | 모든 환자 동일 |
| 1 | `Entrez_Gene_Id` | 유전자 ID (정수) | **모든 환자 동일** |
| 2 | `Expression` | RNA 발현량 | **환자별 다름** |

### 2.3 버그 원인

**기존 코드**:
```python
if df.shape[1] >= 2:
    gene_names = df.iloc[:, 0].astype(str).tolist()       # Hugo_Symbol (정상)
    gene_expression = df.iloc[:, 1].astype(float).tolist() # Entrez_Gene_Id (버그!)
```

- CSV의 **두 번째 열**(`Entrez_Gene_Id`)을 expression 값으로 사용
- `Entrez_Gene_Id`는 유전자 고유 ID로 **모든 환자에서 동일**
- 결과: 모든 환자에 대해 동일한 입력 → **동일한 추론 결과**

---

## 3. 검증 결과

### 3.1 추론 비교 테스트

| OCS_ID | 버그 방식 (Entrez_Gene_Id) | 수정 방식 (Expression) |
|--------|---------------------------|------------------------|
| | Risk / Grade / Surv(일) | Risk / Grade / Surv(일) |
| ocs_0016 | -3.0560 / Grade IV / 1525 | -2.6592 / Grade IV / 1479 |
| ocs_0018 | -3.0560 / Grade IV / 1525 | -2.6791 / Grade IV / 1482 |
| ocs_0020 | -3.0560 / Grade IV / 1525 | -2.6964 / Grade IV / 1484 |
| ocs_0022 | -3.0560 / Grade IV / 1525 | -2.5161 / Grade IV / 1461 |
| ocs_0024 | -3.0560 / Grade IV / 1525 | -2.6804 / Grade IV / 1482 |

### 3.2 통계 비교

| 지표 | 버그 방식 | 수정 방식 |
|------|----------|----------|
| Risk 범위 | -3.0560 ~ -3.0560 | -2.6964 ~ -2.5161 |
| Risk 차이 | **0.000000** | **0.180325** |
| 분산 | 0 (완전 동일) | 0.0047 (환자별 차이) |

---

## 4. 수정 내용

### 4.1 수정 파일

`modAI/services/mg_service.py`

### 4.2 변경된 메서드

#### `load_csv()` (Line 50-89)

```python
# 변경 전
if df.shape[1] >= 2:
    gene_names = df.iloc[:, 0].astype(str).tolist()
    gene_expression = df.iloc[:, 1].astype(float).tolist()  # 버그

# 변경 후
if 'Expression' in df.columns:
    gene_names = df['Hugo_Symbol'].astype(str).tolist() if 'Hugo_Symbol' in df.columns else df.iloc[:, 0].astype(str).tolist()
    gene_expression = df['Expression'].astype(float).tolist()  # 수정
elif df.shape[1] >= 3:
    gene_names = df.iloc[:, 0].astype(str).tolist()
    gene_expression = df.iloc[:, -1].astype(float).tolist()  # 마지막 열
elif df.shape[1] >= 2:
    gene_names = df.iloc[:, 0].astype(str).tolist()
    gene_expression = df.iloc[:, 1].astype(float).tolist()
```

#### `load_csv_content()` (Line 91-130)

동일한 로직으로 수정

### 4.3 변경 로직 요약

| 조건 | 처리 |
|------|------|
| `Expression` 열 존재 | `df['Expression']` 사용 (우선) |
| 3열 이상 | 마지막 열 사용 (`df.iloc[:, -1]`) |
| 2열 | 두 번째 열 사용 (기존 호환) |
| 1열 | 첫 번째 열 사용 |

---

## 5. 적용 방법

### 5.1 Docker 재시작

```bash
docker restart nn-fastapi nn-fastapi-celery
```

### 5.2 재시작 필요 컨테이너

| 컨테이너 | 역할 |
|----------|------|
| `nn-fastapi` | FastAPI 서버 (동기 추론) |
| `nn-fastapi-celery` | Celery worker (비동기 추론) |

### 5.3 볼륨 마운트 확인

```
../modAI -> /app (bind mount)
```

로컬 파일 수정이 컨테이너에 즉시 반영되므로 **restart만으로 충분**

---

## 6. 검증 방법

```bash
# Docker 컨테이너에서 테스트
docker exec nn-fastapi python -c "
from services.mg_service import MGInferenceService
service = MGInferenceService()
data = service.load_csv('/tmp/ocs_0016.csv')
print('Expression 첫 5개:', data['gene_expression'][:5])
"
```

---

## 7. 영향 범위

- MG 추론 API (`/api/v1/mg/inference`, `/api/v1/mg/test`)
- Celery task (`run_mg_inference`)
- Django에서 MG 추론 요청 시 모든 결과

---

## 8. 수정 후 검증 결과

### 8.1 전체 추론 결과 테이블 (수정 후)

| OCS_ID | Risk Score | Risk Cat | Grade | Grade Prob | Surv(일) | Surv(월) | Rec Prob | Recurrence | TMZ Response |
|--------|------------|----------|-------|------------|----------|----------|----------|------------|--------------|
| ocs_0016 | -2.6592 | Low | Grade IV | 0.5399 | 1479 | 48.6 | 0.4473 | No_Recurrence | Uncertain |
| ocs_0018 | -2.6791 | Low | Grade IV | 0.5359 | 1482 | 48.7 | 0.4457 | No_Recurrence | Uncertain |
| ocs_0020 | -2.6964 | Low | Grade IV | 0.5318 | 1484 | 48.8 | 0.4449 | No_Recurrence | Uncertain |
| ocs_0022 | -2.5161 | Low | Grade IV | 0.5710 | 1461 | 48.0 | 0.4563 | No_Recurrence | Likely Responsive |
| ocs_0024 | -2.6804 | Low | Grade IV | 0.5356 | 1482 | 48.7 | 0.4457 | No_Recurrence | Uncertain |
| ocs_0026 | -2.5868 | Low | Grade IV | 0.5562 | 1470 | 48.3 | 0.4515 | No_Recurrence | Uncertain |
| ocs_0028 | -2.5534 | Low | Grade IV | 0.5632 | 1466 | 48.2 | 0.4538 | No_Recurrence | Likely Responsive |
| ocs_0030 | -2.6329 | Low | Grade IV | 0.5458 | 1476 | 48.5 | 0.4488 | No_Recurrence | Uncertain |
| ocs_0032 | -2.5871 | Low | Grade IV | 0.5559 | 1471 | 48.3 | 0.4517 | No_Recurrence | Uncertain |
| ocs_0034 | -2.6101 | Low | Grade IV | 0.5509 | 1473 | 48.4 | 0.4502 | No_Recurrence | Uncertain |
| ocs_0036 | -2.6487 | Low | Grade IV | 0.5424 | 1478 | 48.6 | 0.4477 | No_Recurrence | Uncertain |
| ocs_0038 | -2.6659 | Low | Grade IV | 0.5388 | 1480 | 48.6 | 0.4466 | No_Recurrence | Uncertain |
| ocs_0040 | -2.7075 | Low | Grade IV | 0.5295 | 1485 | 48.8 | 0.4441 | No_Recurrence | Likely Resistant |
| ocs_0042 | -2.5983 | Low | Grade IV | 0.5537 | 1472 | 48.4 | 0.4508 | No_Recurrence | Uncertain |
| ocs_0044 | -2.6009 | Low | Grade IV | 0.5529 | 1472 | 48.4 | 0.4508 | No_Recurrence | Uncertain |

### 8.2 수정 전후 비교

| 지표 | 수정 전 (버그) | 수정 후 |
|------|---------------|---------|
| Risk Score 범위 | -3.0560 ~ -3.0560 | -2.7075 ~ -2.5161 |
| Risk Score 차이 | **0.0000** | **0.1915** |
| Survival Days 범위 | 1525 ~ 1525 | 1461 ~ 1485 |
| Survival Days 차이 | **0** | **24** |
| TMZ Response 다양성 | 모두 동일 | 3종류 (Responsive/Resistant/Uncertain) |

### 8.3 통계 분석 (수정 후)

| 지표 | 값 |
|------|-----|
| Risk Score 평균 | -2.6282 |
| Risk Score 범위 | -2.7075 ~ -2.5161 |
| Survival Days 범위 | 1461 ~ 1485일 |
| Recurrence Prob 범위 | 0.4441 ~ 0.4563 |
| Grade 분포 | Grade IV: 100% |

---

## 9. 결론

### 9.1 문제 원인
CSV 파싱 로직이 잘못된 열(`Entrez_Gene_Id`)을 읽어 모든 환자에서 동일한 추론 결과가 발생했습니다.

### 9.2 해결
`Expression` 열을 올바르게 읽도록 `load_csv()` 및 `load_csv_content()` 메서드를 수정했습니다.

### 9.3 검증 결과
- **수정 전**: 모든 환자 Risk = -3.0560 (동일)
- **수정 후**: Risk 범위 -2.7075 ~ -2.5161 (환자별 차이 존재)

✅ **버그 수정 완료 및 검증 성공**
